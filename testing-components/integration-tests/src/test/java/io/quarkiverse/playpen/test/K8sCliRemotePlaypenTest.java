package io.quarkiverse.playpen.test;

import static io.restassured.RestAssured.given;
import static org.hamcrest.CoreMatchers.startsWith;

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.condition.EnabledIfSystemProperty;

import io.quarkiverse.playpen.kubernetes.crds.PlaypenConfig;
import io.quarkiverse.playpen.test.util.PlaypenUtil;
import io.quarkiverse.playpen.test.util.command.PlaypenCli;
import io.quarkiverse.playpen.test.util.command.PlaypenMvn;

@EnabledIfSystemProperty(named = "k8s", matches = "true")
public class K8sCliRemotePlaypenTest extends BaseK8sTest {
    static String greetingService;

    @BeforeAll
    public static void setService() {
        greetingService = nodeHost + ":30607";

    }

    @Test
    public void testRemotePlaypen() throws Exception {

        String configName = "expose-none-auth-none";
        PlaypenConfig config = createConfig(configName);
        client.resource(config).create();
        Thread.sleep(100);

        try {
            PlaypenUtil.createPlaypen(client, "greeting", configName);

            PlaypenMvn mvn = new PlaypenMvn()
                    .workDir(System.getProperty("user.dir") + "/greeting")
                    .remote().create("greeting");
            Assertions.assertEquals(0, mvn.exitCode(), "Failed to create remote playpen");
            try {
                PlaypenCli cli = new PlaypenCli()
                        .executeAsync("remote connect greeting -hijack -host pod/greeting-playpen-"
                                + System.getProperty("user.name"));
                try {
                    String found = cli.waitForStdout("Control-C", "[ERROR]", "Usage");
                    if (!found.equals("Control-C")) {
                        throw new RuntimeException("Failed to start CLI");
                    }
                    System.out.println("Test remote session");
                    given()
                            .baseUri("http://" + greetingService)
                            .when().get("/hello")
                            .then()
                            .statusCode(200)
                            .body(startsWith("Local Hello developer"));
                } finally {
                    cli.exit();
                }
            } finally {
                mvn = new PlaypenMvn()
                        .workDir(System.getProperty("user.dir") + "/greeting")
                        .remote().delete("greeting");
            }
        } finally {
            PlaypenUtil.deletePlaypen(client, "greeting");
            client.resource(config).delete();
            Thread.sleep(1000);
        }
    }

}
